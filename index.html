<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MindForge</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 700px; margin: 20px auto; background: #f7f7f7; padding: 15px; }
  h1, h2 { text-align: center; color: #333; }
  .section { background: #fff; padding: 15px; margin-bottom: 25px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
  input[type=text] { width: 65%; padding: 8px; margin-right: 8px; }
  button { padding: 8px 15px; margin-right: 6px; cursor: pointer; border-radius: 5px; border: none; background-color: #4a90e2; color: white; }
  button:hover { background-color: #357abd; }
  .item-btn { background: #eee; color: #555; margin-left: 10px; }
  .item-btn:hover { background: #f8d7da; color: #a71d2a; }
  .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin: 10px 0; }
  .calendar-header, .calendar-day { padding: 7px 0; text-align: center; user-select: none; border-radius: 6px; }
  .calendar-header { font-weight: bold; background: #ddd; }
  .calendar-day { background: #fff; cursor: pointer; transition: background 0.3s; }
  .calendar-day.marked { background: #76c776; color: #1d5b1d; font-weight: bold; }
  .progress-bar { background: #ddd; border-radius: 8px; height: 22px; margin-top: 5px; }
  .progress-fill { background: #4a90e2; height: 100%; border-radius: 8px; transition: width 0.4s ease; }
  ul { margin-top: 12px; padding-left: 20px; }
  li { margin-bottom: 6px; }
  .info-list button { margin-left: 10px; }
  .back-btn { background-color: #999; }
  .back-btn:hover { background-color: #666; }
</style>
</head>
<body>

<h1>Evolução</h1>

<h2>Seja ousado e forças poderosas o ajudarão - Johann Goethe</h2>

<div class="section" id="metasSection">
  <h3>Metas Diárias</h3>
  <input type="text" id="inputGoal" placeholder="Ex: Meditar 10 min" />
  <button onclick="addGoal()">Adicionar Meta</button>
  <ul id="listGoals"></ul>
</div>

<div id="metaPage" style="display:none;"></div>

<script>
  // Meta: {nome:string, praticados:Set<string>, info:Array<string>}
  let goals = [];

  function renderGoals() {
    const ul = document.getElementById('listGoals');
    ul.innerHTML = '';
    goals.forEach((goal, idx) => {
      const li = document.createElement('li');
      li.textContent = goal.nome;
      const btnView = document.createElement('button');
      btnView.textContent = 'Ver Meta';
      btnView.className = 'item-btn';
      btnView.onclick = ()=>openMetaPage(idx);
      const btnDel = document.createElement('button');
      btnDel.textContent = 'Excluir';
      btnDel.className = 'item-btn';
      btnDel.onclick = ()=>{ goals.splice(idx, 1); renderGoals(); };
      li.appendChild(btnView);
      li.appendChild(btnDel);
      ul.appendChild(li);
    });
  }

  function addGoal(){
    const input = document.getElementById('inputGoal');
    const val = input.value.trim();
    if(val){
      goals.push({nome: val, praticados: new Set(), info: []});
      renderGoals();
      input.value = '';
    }
  }

  function openMetaPage(idx){
    const g = goals[idx];
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();

    // Dia 1 da semana (0=Domingo)
    const firstDay = new Date(year, month,1).getDay();

    // Número de dias do mês
    const daysInMonth = new Date(year, month+1, 0).getDate();

    // Construir calendário
    let calHtml = '<div class="calendar">';
    ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'].forEach(d=> calHtml+=`<div class="calendar-header">${d}</div>`);
    for(let i=0; i<firstDay; i++) calHtml+='<div></div>';
    for(let d=1; d<=daysInMonth; d++){
      // Criar data ISO em UTC para evitar fuso
      let dateISO = new Date(Date.UTC(year, month, d)).toISOString().slice(0,10);
      let marked = g.praticados.has(dateISO);
      calHtml+=`<div class="calendar-day${marked?' marked':''}" onclick="togglePraticado(${idx},'${dateISO}')">${d}</div>`;
    }
    calHtml+='</div>';

    // Progresso mensal
    let praticadosMes = [...g.praticados].filter(dateStr=>{
      let d = new Date(dateStr);
      return d.getUTCFullYear()===year && d.getUTCMonth()===month;
    }).length;
    let percentMes = Math.round(praticadosMes/daysInMonth*100);
    let barWidthMes = Math.max(20, (praticadosMes/daysInMonth)*300);

    // Progresso anual
    const daysInYear = isLeap(year)?366:365;
    let praticadosAno = [...g.praticados].filter(dateStr=>{
      let d = new Date(dateStr);
      return d.getUTCFullYear()===year;
    }).length;
    let percentAno = Math.round(praticadosAno/daysInYear*100);
    let barWidthAno = Math.max(20, (praticadosAno/daysInYear)*300);

    let progressHtml = `
      <div>
        <b>Progresso Mensal: ${praticadosMes} de ${daysInMonth} dias (${percentMes}%)</b>
        <div class="progress-bar"><div class="progress-fill" style="width:${barWidthMes}px;"></div></div>
      </div>
      <div>
        <b>Progresso Anual: ${praticadosAno} de ${daysInYear} dias (${percentAno}%)</b>
        <div class="progress-bar" style="background:#ddf;"><div class="progress-fill" style="background:#3399cc; width:${barWidthAno}px;"></div></div>
      </div>
    `;

    // Área de informações
    let infoHtml = `
      <h3>Informações</h3>
      <input type="text" id="inputInfo" placeholder="Anote aprendizado ou ideia..." />
      <button onclick="addInfo(${idx})">Adicionar</button>
      <ul id="infoList" class="info-list"></ul>
    `;

    const backBtn = `<button class="item-btn back-btn" onclick="voltar()">Voltar</button>`;

    document.getElementById('metaPage').innerHTML = `
      <div class="section">
        <h2>${g.nome}</h2>
        ${progressHtml}
        ${calHtml}
        ${infoHtml}
        ${backBtn}
      </div>
    `;
    document.getElementById('metaPage').style.display = 'block';
    document.getElementById('metasSection').style.display = 'none';

    renderInfo(idx);
  }

  // Marcar ou desmarcar dia praticado
  function togglePraticado(idx, dateISO){
    let g = goals[idx];
    if(g.praticados.has(dateISO)) g.praticados.delete(dateISO);
    else g.praticados.add(dateISO);
    openMetaPage(idx);
  }

  // Adicionar informação texto
  function addInfo(idx){
    const input = document.getElementById('inputInfo');
    let val = input.value.trim();
    if(val){
      goals[idx].info.push(val);
      input.value = '';
      renderInfo(idx);
    }
  }

  // Excluir informação texto
  function deleteInfo(idx, infoIdx){
    goals[idx].info.splice(infoIdx,1);
    renderInfo(idx);
  }

  // Renderiza lista info
  function renderInfo(idx){
    const ul = document.getElementById('infoList');
    if(!ul) return;
    ul.innerHTML = '';
    goals[idx].info.forEach((txt,i)=>{
      const li = document.createElement('li');
      li.textContent = txt;
      const btn = document.createElement('button');
      btn.textContent = 'Excluir';
      btn.className = 'item-btn';
      btn.onclick = ()=>deleteInfo(idx,i);
      li.appendChild(btn);
      ul.appendChild(li);
    });
  }

  // Voltar para página metas
  function voltar(){
    document.getElementById('metaPage').style.display = 'none';
    document.getElementById('metasSection').style.display = 'block';
    renderGoals();
  }

  // Ano bissexto?
  function isLeap(year){
    return (year%4===0)&&(year%100!==0 || year%400===0);
  }

  renderGoals();
</script>

</body>
</html>
